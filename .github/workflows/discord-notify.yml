name: GitHub All Events to Discord

on:
    push:
    pull_request:
    issues:
        types: [opened, edited, closed] # Issue ìƒì„±Â·ìˆ˜ì •Â·ë‹«í˜
    issue_comment:
    create: # ë¸Œëœì¹˜ í˜¹ì€ íƒœê·¸ ìƒì„±
    delete:
    release:
        types: [published, created]
    workflow_run:
        workflows: ["*"]
        types: [completed]

jobs:
    discordNotification:
        runs-on: ubuntu-latest
        steps:
            - name: Send message to Discord
              env:
                  DISCORD_WEBHOOK_URL: ${{ secrets.DISCORD_WEBHOOK_URL }}
              run: |
                  # ì´ë²¤íŠ¸ ê¸°ë³¸ ì •ë³´
                  EVENT_TYPE="${{ github.event_name }}"
                  ACTION="${{ github.event.action }}"
                  REPO_NAME="${{ github.repository }}"
                  REF_FULL="${{ github.ref }}"
                  BRANCH_NAME="${REF_FULL#refs/heads/}"
                  ACTOR="${{ github.actor }}"

                  # ê³µí†µ ë©”ì‹œì§€ í—¤ë”
                  MESSAGE="ğŸ“¢ **GitHub ì´ë²¤íŠ¸ ë°œìƒ**
                    ğŸ”” ì´ë²¤íŠ¸ íƒ€ì…: ${EVENT_TYPE}${ACTION:+ (${ACTION})}
                    ğŸ“Œ ë ˆí¬ì§€í† ë¦¬: ${REPO_NAME}
                    ğŸŒ¿ ë¸Œëœì¹˜: ${BRANCH_NAME}
                    ğŸ‘¤ ì‹¤í–‰ì: ${ACTOR}"

                  # 1) push ì´ë²¤íŠ¸ ì²˜ë¦¬ (ê¸°ì¡´ ë¡œì§ ìœ ì§€)
                  if [[ "$EVENT_TYPE" == "push" ]]; then
                    COMMIT_LIST=""
                    COMMITS_JSON=$(echo '${{ toJson(github.event.commits) }}' | jq -c '.')
                    while IFS= read -r commit; do
                      MSG=$(echo "$commit" | jq -r '.message')
                      URL=$(echo "$commit" | jq -r '.url')
                      AUTHOR=$(echo "$commit" | jq -r '.author.name')
                      COMMIT_LIST="${COMMIT_LIST}\nğŸ“ ${MSG} - ğŸ‘¤ ${AUTHOR}\nğŸ”— [ì»¤ë°‹ ë³´ê¸°](${URL})"
                    done < <(echo "$COMMITS_JSON" | jq -c '.[]')
                    [[ -n "$COMMIT_LIST" ]] \
                      && MESSAGE="$MESSAGE\n\nğŸ”„ **í‘¸ì‹œëœ ì»¤ë°‹ ëª©ë¡:**$COMMIT_LIST" \
                      || MESSAGE="$MESSAGE\n\nğŸ”„ **í‘¸ì‹œëœ ì»¤ë°‹ì´ ì—†ìŠµë‹ˆë‹¤.**"

                  # 2) pull_request ì´ë²¤íŠ¸ ì²˜ë¦¬ (ê¸°ì¡´ ë¡œì§ ìœ ì§€)
                  elif [[ "$EVENT_TYPE" == "pull_request" ]]; then
                    PR_TITLE="${{ github.event.pull_request.title }}"
                    PR_URL="${{ github.event.pull_request.html_url }}"
                    PR_STATE="${{ github.event.pull_request.state }}"
                    PR_AUTHOR="${{ github.event.pull_request.user.login }}"
                    MESSAGE="$MESSAGE

                    ğŸ”€ **Pull Request ${PR_STATE^}**
                    â€¢ ì œëª©: ${PR_TITLE}
                    â€¢ ì‘ì„±ì: ${PR_AUTHOR}
                    ğŸ”— [PR ë³´ê¸°](${PR_URL})"

                  # 3) issues ì´ë²¤íŠ¸ ì²˜ë¦¬ (ì´ìŠˆ ìƒì„±Â·ìˆ˜ì •Â·ë‹«í˜)
                  elif [[ "$EVENT_TYPE" == "issues" ]]; then
                    ISSUE_TITLE="${{ github.event.issue.title }}"
                    ISSUE_URL="${{ github.event.issue.html_url }}"
                    ISSUE_AUTHOR="${{ github.event.issue.user.login }}"
                    MESSAGE="$MESSAGE

                    ğŸ› **Issue ${ACTION^}**
                    â€¢ ì œëª©: ${ISSUE_TITLE}
                    â€¢ ì‘ì„±ì: ${ISSUE_AUTHOR}
                    ğŸ”— [Issue ë³´ê¸°](${ISSUE_URL})"

                  # 4) create ì´ë²¤íŠ¸ ì²˜ë¦¬ (ë¸Œëœì¹˜Â·íƒœê·¸ ìƒì„±)
                  elif [[ "$EVENT_TYPE" == "create" ]]; then
                    REF_TYPE="${{ github.event.ref_type }}"   # branch or tag
                    REF_NAME="${{ github.event.ref }}"
                    if [[ "$REF_TYPE" == "branch" ]]; then
                      MESSAGE="$MESSAGE

                    ğŸŒ± **ë¸Œëœì¹˜ ìƒì„±**: ${REF_NAME}"
                    else
                    MESSAGE="$MESSAGE

                    ğŸ·ï¸ **íƒœê·¸ ìƒì„±**: ${REF_NAME}"
                    fi
                  fi

                  # Discordìš© í˜ì´ë¡œë“œ ìƒì„± ë° ì „ì†¡
                  PAYLOAD=$(jq -n \
                    --arg username "GitHub Webhook" \
                    --arg content "$(echo -e "$MESSAGE")" \
                    '{username: $username, content: $content}')
                  curl -H "Content-Type: application/json" \
                       -X POST \
                       -d "$PAYLOAD" \
                       "$DISCORD_WEBHOOK_URL"
