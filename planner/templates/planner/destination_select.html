{% load django_bootstrap5 %}

<style>
  /* 확장된 상태에서 왼쪽 영역 스타일 */
  #map-picker-area.expanded {
    flex: 1 1 0 !important;
    max-width: none !important;
    width: 100%;
    justify-content: center !important;
  }
  /* 확장 시 오른쪽 영역과 구분선을 숨길 때 사용할 클래스 */
  .hidden-by-js {
    display: none !important;
  }
  /* 클릭 후 지도 섹션이 나타날 때, 지도 영역 높이 지정 */
  #map {
    width: 100%;
    height: 400px;
  }
  /* 위치 출력란과 버튼을 가로로 정렬 */
  #location-info {
    width: calc(100% - 150px);
    padding: 0.375rem 0.75rem;
    border: 1px solid #ced4da;
    border-radius: 0.25rem;
    font-size: 1rem;
    line-height: 1.5;
    color: #495057;
    background-color: #e9ecef;
  }
</style>

<!-- 1) 상단 선택 영역 -->
<div
  id="destination-selector"
  class="d-inline-flex align-items-center justify-content-center bg-white shadow-sm rounded"
  style="width: 1000px; height: 60px; padding: 0 15px;"
>
  <!-- 왼쪽: 지도에서 여행지 고르기 -->
  <div
    id="map-picker-area"
    class="d-flex flex-fill align-items-center justify-content-end"
    style="max-width: 480px; cursor: pointer;"
  >
    <div class="d-flex align-items-center gap-2">
      <img
        src="/static/images/globe.svg"
        alt="globe"
        style="width: 24px; height: 24px;"
      >
      <div
        id="map-picker-text"
        class="d-flex flex-column justify-content-center text-dark"
        style="font-size: 20px; font-family: 'Noto Sans KR'; font-weight: 300; line-height: 20px;"
      >
        지도에서 여행지 고르기
      </div>
    </div>
  </div>

  <!-- 구분선 -->
  <div
    id="separator"
    style="width: 30px; height: 0; transform: rotate(90deg); transform-origin: top left; border-top: 1px solid #e5e5e5; margin: 0 10px;"
  ></div>

  <!-- 오른쪽: 여행지 검색하기 -->
  <div
    id="search-picker-area"
    class="d-flex flex-fill align-items-center justify-content-start"
    style="max-width: 480px;"
  >
    <div class="d-flex align-items-center gap-2">
      <img
        src="/static/images/lens.svg"
        alt="search"
        style="width: 24px; height: 24px;"
      >
      <div
        id="search-picker-text"
        class="d-flex flex-column justify-content-center text-dark"
        style="font-size: 20px; font-family: 'Noto Sans KR'; font-weight: 300; line-height: 20px;"
      >
        여행지 검색하기
      </div>
    </div>
  </div>
</div>

<!-- 2) 지도와 위치 출력란, 확인 버튼이 나타날 섹션 (초기엔 hidden) -->
<div id="map-section" class="mt-3 d-none" style="width: 1000px;">
  <!-- 실제 지도가 그려질 영역 -->
  <div id="map"></div>

  <!-- 위치 출력란 및 확인 버튼 -->
  <div class="d-flex align-items-center justify-content-between mt-2">
    <!-- 위치 정보 출력란 -->
    <div id="location-info" class="me-2">
      <!-- 클릭한 좌표 또는 주소가 여기에 표시됩니다 -->
      선택된 위치 정보가 여기에 표시됩니다.
    </div>
    <!-- 여행지 선택 버튼 -->
    <button
      id="confirm-location-btn"
      type="button"
      class="btn btn-primary"
      disabled
    >
      여행지 선택
    </button>
  </div>
</div>

{% block script %}
<script>
  // --- 전역 변수 정의 ---
  let map;
  let singleMarker = null;
  let clickedPosition = null;

  document.addEventListener('DOMContentLoaded', () => {
    const mapPickerArea = document.getElementById('map-picker-area');
    const searchPickerArea = document.getElementById('search-picker-area');
    const separator = document.getElementById('separator');
    const mapSection = document.getElementById('map-section');
    const confirmButton = document.getElementById('confirm-location-btn');
    const locationInfo = document.getElementById('location-info');

    // 1) 왼쪽 영역에 마우스 오버 시 확장
    mapPickerArea.addEventListener('mouseenter', () => {
      mapPickerArea.classList.add('expanded');

      // 구분선과 오른쪽 영역 숨기기
      separator.classList.add('hidden-by-js');
      searchPickerArea.classList.add('hidden-by-js');

      // 텍스트를 가운데 정렬
      mapPickerArea.style.justifyContent = 'center';
    });

    // 2) 마우스가 영역을 벗어나면 원래 상태로 복원
    mapPickerArea.addEventListener('mouseleave', () => {
      if (!mapSection.classList.contains('d-block')) {
        // 확장 클래스 제거
        mapPickerArea.classList.remove('expanded');
        // 숨겼던 요소들 다시 보이도록
        separator.classList.remove('hidden-by-js');
        searchPickerArea.classList.remove('hidden-by-js');
        // 원래 정렬로 복원
        mapPickerArea.style.justifyContent = 'flex-end';
      }
    });

    // 3) 왼쪽 영역 클릭 시 map-section 표시 및 Google Maps 초기화
    mapPickerArea.addEventListener('click', () => {
      // 이미 map-section이 보이는 상태라면 추가 초기화 불필요
      if (!mapSection.classList.contains('d-block')) {
        // map-section 보이기
        mapSection.classList.remove('d-none');
        mapSection.classList.add('d-block');

        // Google Maps 초기화
        initMap();
      }
    });

    // 4) 여행지 선택 버튼 클릭 시 최종 위치 확정 처리
    confirmButton.addEventListener('click', () => {
      if (clickedPosition) {
        // 예: 서버로 위치 정보를 전송하거나, 다음 단계로 이동
        // 여기서는 콘솔에 출력
        console.log('최종 선택 위치:', clickedPosition);

        // 예시: hidden input에 값을 담아서 폼 제출하거나, location.href 변경 등
        // const hiddenInput = document.createElement('input');
        // hiddenInput.type = 'hidden';
        // hiddenInput.name = 'selected_latlng';
        // hiddenInput.value = clickedPosition.lat + ',' + clickedPosition.lng;
        // document.forms[0].appendChild(hiddenInput);
        // document.forms[0].submit();
      }
    });

    // 5) map 영역에서 클릭 시 마커 생성/이동 처리
    window.placeSingleMarker = (latLng) => {
      if (singleMarker) {
        singleMarker.setPosition(latLng);
      } else {
        singleMarker = new google.maps.Marker({
          position: latLng,
          map: map
        });
      }
      clickedPosition = latLng;

      // 위치 정보 출력란에 좌표 표시
      locationInfo.textContent = `위도: ${latLng.lat().toFixed(6)}, 경도: ${latLng.lng().toFixed(6)}`;

      // 확인 버튼 활성화
      confirmButton.disabled = false;
    };
  });

  // 6) Google Maps API 호출 후 실행될 콜백 함수. 
  //    YOUR_API_KEY 부분에 본인의 API 키를 넣어주세요.
  function initMap() {
    const defaultCenter = { lat: 37.5665, lng: 126.9780 }; // 서울 중심 좌표 예시

    map = new google.maps.Map(document.getElementById('map'), {
      center: defaultCenter,
      zoom: 12
    });

    // 클릭 리스너: 클릭한 지점에 단일 마커 표시
    map.addListener('click', (event) => {
      placeSingleMarker(event.latLng);
    });
  }
</script>

<!-- Google Maps JS API 로드 (YOUR_API_KEY 를 실제 키로 교체) -->
<script async
  src="https://maps.googleapis.com/maps/api/js?key={{ GOOGLE_PLACES_API_KEY }}&callback=initMap">
</script>
{% endblock %}
