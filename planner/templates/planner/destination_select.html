{% load django_bootstrap5 %}
<style>
  /* 확장된 상태에서 왼쪽 영역 스타일 */
  #map-picker-area.expanded {
    flex: 1 1 0 !important;
    max-width: none !important;
    width: 100%;
    justify-content: center !important;
  }

  /* 확장 시 오른쪽 영역과 구분선을 숨길 때 사용할 클래스 */
  .hidden-by-js {
    display: none !important;
  }

  /* 클릭 후 지도 섹션이 나타날 때, 지도 영역 높이 지정 */
  #map {
    width: 100%;
    height: 400px;
  }

  /* 위치 출력란과 버튼을 가로로 정렬 */
  #location-info {
    width: calc(100% - 150px);
    padding: 0.375rem 0.75rem;
    border: 1px solid #ced4da;
    border-radius: 0.25rem;
    font-size: 1rem;
    line-height: 1.5;
    color: #495057;
    background-color: #e9ecef;
  }
</style>
<!-- 1) 상단 선택 영역 -->
<div id="destination-selector"
     class="d-inline-flex align-items-center justify-content-center bg-white shadow-sm rounded"
     style="width: 1000px;
            height: 60px;
            padding: 0 15px">
  <!-- 왼쪽: 지도에서 여행지 고르기 -->
  <div id="map-picker-area"
       class="d-flex flex-fill align-items-center justify-content-end"
       style="max-width: 480px;
              cursor: pointer">
    <div class="d-flex align-items-center gap-2">
      <img src="/static/images/globe.svg"
           alt="globe"
           style="width: 24px;
                  height: 24px" />
      <div id="map-picker-text"
           class="d-flex flex-column justify-content-center text-dark"
           style="font-size: 20px;
                  font-family: 'Noto Sans KR';
                  font-weight: 300;
                  line-height: 20px">지도에서 여행지 고르기</div>
    </div>
  </div>
  <!-- 구분선 -->
  <div id="separator"
       style="width: 30px;
              height: 0;
              transform: rotate(90deg);
              transform-origin: top left;
              border-top: 1px solid #e5e5e5;
              margin: 0 10px"></div>
  <!-- 오른쪽: 여행지 검색하기 -->
  <div id="search-picker-area"
       class="d-flex flex-fill align-items-center justify-content-start"
       style="max-width: 480px">
    <div class="d-flex align-items-center gap-2">
      <img src="/static/images/lens.svg"
           alt="search"
           style="width: 24px;
                  height: 24px" />
      <div id="search-picker-text"
           class="d-flex flex-column justify-content-center text-dark"
           style="font-size: 20px;
                  font-family: 'Noto Sans KR';
                  font-weight: 300;
                  line-height: 20px">여행지 검색하기</div>
    </div>
  </div>
</div>
<!-- 2) 지도와 위치 출력란, 확인 버튼이 나타날 섹션 (초기엔 hidden) -->
<div id="map-section" class="mt-3 d-none" style="width: 1000px;">
  <!-- 실제 지도가 그려질 영역 -->
  <div id="map"></div>
  <!-- 에러 메시지 출력용 (대한민국 클릭 시) -->
  <div id="error-message" class="alert alert-danger mt-2 d-none">대한민국은 여행지로 선택할 수 없습니다.</div>
  <!-- 위치 출력란 및 확인 버튼 -->
  <div class="d-flex align-items-center justify-content-between mt-2">
    <!-- 위치 정보 출력란 -->
    <div id="location-info" class="me-2">선택된 위치 정보가 여기에 표시됩니다.</div>
    <!-- 여행지 선택 버튼 -->
    <button id="confirm-location-btn"
            type="button"
            class="btn btn-primary"
            disabled>여행지 선택</button>
  </div>
</div>
{% block script %}
  <script>
  // --- 추가: 선택된 장소 정보를 담을 객체 ---
  let selectedPlaceData = {
    name: null,
    address: null,
    placeId: null,
    lat: null,
    lng: null,
    country: null,
    region: null,
  };

  // --- 추가: 현재 TravelPlan ID
  const planId = window.planId;

  // --- 전역 변수 정의 (initMap과 콜백에서 모두 접근 가능하도록) ---
  let map;
  let singleMarker = null;
  let clickedPosition = null;
  let geocoder;
  let placesService; // PlacesService를 전역 변수로 선언

  // DOM 요소도 전역 변수로 선언만 해둡니다.
  let mapPickerArea;
  let searchPickerArea;
  let separator;
  let mapSection;
  let confirmButton;
  let locationInfo;
  let errorMessage;

  document.addEventListener("DOMContentLoaded", () => {
    // DOM 로딩 후에 전역 변수에 요소 할당
    mapPickerArea = document.getElementById("map-picker-area");
    searchPickerArea = document.getElementById("search-picker-area");
    separator = document.getElementById("separator");
    mapSection = document.getElementById("map-section");
    confirmButton = document.getElementById("confirm-location-btn");
    locationInfo = document.getElementById("location-info");
    errorMessage = document.getElementById("error-message");

    // 1) 왼쪽 영역에 마우스 오버 시 확장
    mapPickerArea.addEventListener("mouseenter", () => {
      mapPickerArea.classList.add("expanded");
      separator.classList.add("hidden-by-js");
      searchPickerArea.classList.add("hidden-by-js");
      mapPickerArea.style.justifyContent = "center";
    });

    // 2) 마우스가 영역을 벗어나면 원래 상태로 복원 (단, 지도가 열린 상태가 아니면)
    mapPickerArea.addEventListener("mouseleave", () => {
      if (!mapSection.classList.contains("d-block")) {
        mapPickerArea.classList.remove("expanded");
        separator.classList.remove("hidden-by-js");
        searchPickerArea.classList.remove("hidden-by-js");
        mapPickerArea.style.justifyContent = "flex-end";
      }
    });

    // 3) 왼쪽 영역 클릭 시 map-section 표시 및 Google Maps 초기화
    mapPickerArea.addEventListener("click", () => {
      if (!mapSection.classList.contains("d-block")) {
        mapSection.classList.remove("d-none");
        mapSection.classList.add("d-block");
        initMap();
      }
    });

    // 4) 여행지 선택 버튼 클릭 시 API 요청 보내기
    confirmButton.addEventListener("click", () => {
      if (selectedPlaceData.lat && window.planId) {
        // CSRF 토큰 가져오기
        function getCookie(name) {
          let cookieValue = null;
          if (document.cookie && document.cookie !== "") {
            const cookies = document.cookie.split(";");
            for (let i = 0; i < cookies.length; i++) {
              const cookie = cookies[i].trim();
              if (cookie.startsWith(name + "=")) {
                cookieValue = decodeURIComponent(
                  cookie.substring(name.length + 1)
                );
                break;
              }
            }
          }
          return cookieValue;
        }
        const csrftoken = getCookie("csrftoken");

        // 요청 바디에 보낼 데이터
        const bodyData = {
          plan: window.planId,
          name: selectedPlaceData.name,
          type: "destination",
          address: selectedPlaceData.address,
          lat: selectedPlaceData.lat,
          lng: selectedPlaceData.lng,
          place_id: selectedPlaceData.placeId,
        };

        fetch("/api/plan/destination/", {
          method: "POST",
          headers: {
            "Content-Type": "application/json",
            "X-CSRFToken": csrftoken,
          },
          body: JSON.stringify(bodyData),
        })
          .then((response) => {
            if (!response.ok) throw new Error("Network response was not ok");
            return response.json();
          })
          .then((data) => {
            console.log("Destination created:", data);
            // 생성 후 필요한 후속 처리 (리다이렉트 등)
          })
          .catch((error) => {
            console.error("Error creating destination:", error);
          });
      }
    });
  });

  // 5) Google Maps API 호출 후 실행될 콜백 함수
  function initMap() {
    const defaultCenter = { lat: 37.5665, lng: 126.9780 }; // 서울 중심 좌표 예시
    geocoder = new google.maps.Geocoder();

    map = new google.maps.Map(document.getElementById("map"), {
      center: defaultCenter,
      zoom: 12,
    });

    placesService = new google.maps.places.PlacesService(map); // PlacesService 초기화

    // 클릭 리스너: 클릭한 지점이 대한민국인지 확인 후 마커 생성/이동 처리
    map.addListener("click", (event) => {
      if (event.placeId) {
        event.stop(); // 기본 정보 창 표시 방지
        placesService.getDetails(
          {
            placeId: event.placeId,
            fields: ["place_id", "name", "formatted_address", "address_components"],
          },
          (place, status) => {
            if (
              status === google.maps.places.PlacesServiceStatus.OK &&
              place
            ) {
              // ① 국가가 'KR'인지 확인
              let isSouthKorea = false;
              for (const comp of place.address_components) {
                if (
                  comp.types.includes("country") &&
                  comp.short_name === "KR"
                ) {
                  isSouthKorea = true;
                  break;
                }
              }

              if (isSouthKorea) {
                if (singleMarker) {
                  singleMarker.setMap(null);
                  singleMarker = null;
                }
                clickedPosition = null;
                errorMessage.classList.remove("d-none");
                return;
              }

              // ② 마커 생성/이동
              placeSingleMarker(event.latLng);

              // ③ 장소명, 주소, 지역, 국가, 위경도 정보 저장
              const countryComp = place.address_components.find((c) =>
                c.types.includes("country")
              );
              const regionComp =
                place.address_components.find(
                  (c) =>
                    c.types.includes("administrative_area_level_1") ||
                    c.types.includes("locality")
                ) || {};
              selectedPlaceData = {
                name: place.name || "",
                address: place.formatted_address || "",
                placeId: place.place_id || null,
                lat: event.latLng.lat(),
                lng: event.latLng.lng(),
                country: countryComp ? countryComp.long_name : "",
                region: regionComp.long_name || "",
              };

              locationInfo.textContent = `${selectedPlaceData.name} · ${selectedPlaceData.address} (${selectedPlaceData.region}, ${selectedPlaceData.country}) · 위도: ${selectedPlaceData.lat.toFixed(
                6
              )}, 경도: ${selectedPlaceData.lng.toFixed(6)}`;
              confirmButton.disabled = false;
            }
          }
        );
        return;
      }

      // 먼저 에러 메시지와 이전 마커/선택을 초기화
      errorMessage.classList.add("d-none");
      confirmButton.disabled = true;
      locationInfo.textContent = "";

      // 지오코더를 통해 클릭 위치의 주소 정보 가져오기
      geocoder.geocode({ location: event.latLng }, (results, status) => {
        if (status === "OK" && results) {
          // 1) 대한민국인지 판별
          let isSouthKorea = false;
          for (const result of results) {
            for (const comp of result.address_components) {
              if (
                comp.types.includes("country") &&
                comp.short_name === "KR"
              ) {
                isSouthKorea = true;
                break;
              }
            }
            if (isSouthKorea) break;
          }

          if (isSouthKorea) {
            if (singleMarker) {
              singleMarker.setMap(null);
              singleMarker = null;
            }
            clickedPosition = null;
            errorMessage.classList.remove("d-none");
            return;
          }

          // 2) 대한민국이 아니라면, 가장 정확한 주소 결과(result[0])를 사용해 표시
          const primaryResult = results[0];
          const components = primaryResult.address_components;
          let country = "";
          let region = "";
          for (const comp of components) {
            if (comp.types.includes("country")) {
              country = comp.long_name;
            }
            if (
              comp.types.includes("administrative_area_level_1") ||
              comp.types.includes("locality")
            ) {
              region = comp.long_name;
            }
          }
          const formattedAddress = primaryResult.formatted_address;

          // 3) 단일 마커 생성/이동
          placeSingleMarker(event.latLng);

          // 4) 위치 출력란에 주소, 지역, 국가, 위경도 함께 표시
          selectedPlaceData = {
            name: formattedAddress,
            address: formattedAddress,
            placeId: null,
            lat: event.latLng.lat(),
            lng: event.latLng.lng(),
            country: country,
            region: region,
          };
          locationInfo.textContent = `${selectedPlaceData.address} (${selectedPlaceData.region}, ${selectedPlaceData.country}) · 위도: ${selectedPlaceData.lat.toFixed(
            6
          )}, 경도: ${selectedPlaceData.lng.toFixed(6)}`;
          confirmButton.disabled = false;
        } else {
          // geocode 실패 시: 기본 위경도만 표시
          placeSingleMarker(event.latLng);
          selectedPlaceData = {
            name: "",
            address: "",
            placeId: null,
            lat: event.latLng.lat(),
            lng: event.latLng.lng(),
            country: "",
            region: "",
          };
          locationInfo.textContent = `위도: ${selectedPlaceData.lat.toFixed(
            6
          )}, 경도: ${selectedPlaceData.lng.toFixed(6)}`;
          confirmButton.disabled = false;
        }
      });
    });
  }

  // 마커 생성/이동 처리 함수
  function placeSingleMarker(latLng) {
    if (singleMarker) {
      singleMarker.setPosition(latLng);
    } else {
      singleMarker = new google.maps.Marker({
        position: latLng,
        map: map,
      });
    }
    clickedPosition = latLng;
  }
  </script>
  <!-- Google Maps JS API 로드 (libraries=places 추가) -->
  <script async
          src="https://maps.googleapis.com/maps/api/js?key={{ GOOGLE_PLACES_API_KEY }}&libraries=places&callback=initMap"></script>
{% endblock %}
