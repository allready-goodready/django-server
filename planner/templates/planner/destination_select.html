{% load django_bootstrap5 %}

<style>
  /* 확장된 상태에서 왼쪽 영역 스타일 */
  #map-picker-area.expanded {
    flex: 1 1 0 !important;
    max-width: none !important;
    width: 100%;
    justify-content: center !important;
  }
  /* 확장 시 오른쪽 영역과 구분선을 숨길 때 사용할 클래스 */
  .hidden-by-js {
    display: none !important;
  }
  /* 클릭 후 지도 섹션이 나타날 때, 지도 영역 높이 지정 */
  #map {
    width: 100%;
    height: 400px;
  }
  /* 위치 출력란과 버튼을 가로로 정렬 */
  #location-info {
    width: calc(100% - 150px);
    padding: 0.375rem 0.75rem;
    border: 1px solid #ced4da;
    border-radius: 0.25rem;
    font-size: 1rem;
    line-height: 1.5;
    color: #495057;
    background-color: #e9ecef;
  }
</style>

<!-- 1) 상단 선택 영역 -->
<div
  id="destination-selector"
  class="d-inline-flex align-items-center justify-content-center bg-white shadow-sm rounded"
  style="width: 1000px; height: 60px; padding: 0 15px;"
>
  <!-- 왼쪽: 지도에서 여행지 고르기 -->
  <div
    id="map-picker-area"
    class="d-flex flex-fill align-items-center justify-content-end"
    style="max-width: 480px; cursor: pointer;"
  >
    <div class="d-flex align-items-center gap-2">
      <img
        src="/static/images/globe.svg"
        alt="globe"
        style="width: 24px; height: 24px;"
      >
      <div
        id="map-picker-text"
        class="d-flex flex-column justify-content-center text-dark"
        style="font-size: 20px; font-family: 'Noto Sans KR'; font-weight: 300; line-height: 20px;"
      >
        지도에서 여행지 고르기
      </div>
    </div>
  </div>

  <!-- 구분선 -->
  <div
    id="separator"
    style="width: 30px; height: 0; transform: rotate(90deg); transform-origin: top left; border-top: 1px solid #e5e5e5; margin: 0 10px;"
  ></div>

  <!-- 오른쪽: 여행지 검색하기 -->
  <div
    id="search-picker-area"
    class="d-flex flex-fill align-items-center justify-content-start"
    style="max-width: 480px;"
  >
    <div class="d-flex align-items-center gap-2">
      <img
        src="/static/images/lens.svg"
        alt="search"
        style="width: 24px; height: 24px;"
      >
      <div
        id="search-picker-text"
        class="d-flex flex-column justify-content-center text-dark"
        style="font-size: 20px; font-family: 'Noto Sans KR'; font-weight: 300; line-height: 20px;"
      >
        여행지 검색하기
      </div>
    </div>
  </div>
</div>

<!-- 2) 지도와 위치 출력란, 확인 버튼이 나타날 섹션 (초기엔 hidden) -->
<div id="map-section" class="mt-3 d-none" style="width: 1000px;">
  <!-- 실제 지도가 그려질 영역 -->
  <div id="map"></div>

  <!-- 에러 메시지 출력용 (대한민국 클릭 시) -->
  <div id="error-message" class="alert alert-danger mt-2 d-none">
    대한민국은 여행지로 선택할 수 없습니다.
  </div>

  <!-- 위치 출력란 및 확인 버튼 -->
  <div class="d-flex align-items-center justify-content-between mt-2">
    <!-- 위치 정보 출력란 -->
    <div id="location-info" class="me-2">
      선택된 위치 정보가 여기에 표시됩니다.
    </div>
    <!-- 여행지 선택 버튼 -->
    <button
      id="confirm-location-btn"
      type="button"
      class="btn btn-primary"
      disabled
    >
      여행지 선택
    </button>
  </div>
</div>

{% block script %}
<script>
  // --- 전역 변수 정의 (initMap과 콜백에서 모두 접근 가능하도록) ---
  let map;
  let singleMarker = null;
  let clickedPosition = null;
  let geocoder;

  // DOM 요소도 전역 변수로 선언만 해둡니다.
  let mapPickerArea;
  let searchPickerArea;
  let separator;
  let mapSection;
  let confirmButton;
  let locationInfo;
  let errorMessage;

  document.addEventListener('DOMContentLoaded', () => {
    // DOM 로딩 후에 전역 변수에 요소 할당
    mapPickerArea = document.getElementById('map-picker-area');
    searchPickerArea = document.getElementById('search-picker-area');
    separator = document.getElementById('separator');
    mapSection = document.getElementById('map-section');
    confirmButton = document.getElementById('confirm-location-btn');
    locationInfo = document.getElementById('location-info');
    errorMessage = document.getElementById('error-message');

    // 1) 왼쪽 영역에 마우스 오버 시 확장
    mapPickerArea.addEventListener('mouseenter', () => {
      mapPickerArea.classList.add('expanded');
      separator.classList.add('hidden-by-js');
      searchPickerArea.classList.add('hidden-by-js');
      mapPickerArea.style.justifyContent = 'center';
    });

    // 2) 마우스가 영역을 벗어나면 원래 상태로 복원 (단, 지도가 열린 상태가 아니면)
    mapPickerArea.addEventListener('mouseleave', () => {
      if (!mapSection.classList.contains('d-block')) {
        mapPickerArea.classList.remove('expanded');
        separator.classList.remove('hidden-by-js');
        searchPickerArea.classList.remove('hidden-by-js');
        mapPickerArea.style.justifyContent = 'flex-end';
      }
    });

    // 3) 왼쪽 영역 클릭 시 map-section 표시 및 Google Maps 초기화
    mapPickerArea.addEventListener('click', () => {
      if (!mapSection.classList.contains('d-block')) {
        mapSection.classList.remove('d-none');
        mapSection.classList.add('d-block');
        initMap();
      }
    });

    // 4) 여행지 선택 버튼 클릭 시 최종 위치 확정 처리
    confirmButton.addEventListener('click', () => {
      if (clickedPosition) {
        console.log('최종 선택 위치:', clickedPosition);
        // 서버 전송 로직 또는 다음 단계 이동 코드를 여기에 추가
      }
    });
  });

  // 6) Google Maps API 호출 후 실행될 콜백 함수
  function initMap() {
    const defaultCenter = { lat: 37.5665, lng: 126.9780 }; // 서울 중심 좌표 예시
    geocoder = new google.maps.Geocoder();

    map = new google.maps.Map(document.getElementById('map'), {
      center: defaultCenter,
      zoom: 12
    });

    // 클릭 리스너: 클릭한 지점이 대한민국인지 확인 후 마커 생성/이동 처리
    map.addListener('click', (event) => {
      // 먼저 에러 메시지와 이전 마커/선택을 초기화
      errorMessage.classList.add('d-none');
      document.getElementById('confirm-location-btn').disabled = true;
      locationInfo.textContent = '';
      // 지오코더를 통해 클릭 위치의 주소 정보 가져오기
      geocoder.geocode({ location: event.latLng }, (results, status) => {
        if (status === 'OK' && results) {
          // 주소 컴포넌트 중 country를 찾아내기
          let isSouthKorea = false;
          if (results.length > 0) {
            for (const result of results) {
              for (const comp of result.address_components) {
                if (comp.types.includes('country') && comp.short_name === 'KR') {
                  isSouthKorea = true;
                  break;
                }
              }
              if (isSouthKorea) break;
            }
          }
          // 만약 대한민국이라면 에러 출력
          if (isSouthKorea) {
            // 기존 마커 제거
            if (singleMarker) {
              singleMarker.setMap(null);
              singleMarker = null;
            }
            clickedPosition = null;
            errorMessage.classList.remove('d-none');
            return;
          }
          // 대한민국이 아니라면 단일 마커 표시
          placeSingleMarker(event.latLng);
        } else {
          console.error('Geocoder 실패:', status);
          // geocode 실패 시에도 마커를 표시할 수 있지만, 보류하거나 안내 메시지 처리 가능
          placeSingleMarker(event.latLng);
        }
      });
    });
  }

  // 마커 생성/이동 처리 함수
  function placeSingleMarker(latLng) {
    if (singleMarker) {
      singleMarker.setPosition(latLng);
    } else {
      singleMarker = new google.maps.Marker({
        position: latLng,
        map: map
      });
    }
    clickedPosition = latLng;
    // 위치 정보 출력란에 좌표 표시
    locationInfo.textContent = `위도: ${latLng.lat().toFixed(6)}, 경도: ${latLng.lng().toFixed(6)}`;
    // 확인 버튼 활성화
    document.getElementById('confirm-location-btn').disabled = false;
  }
</script>

<!-- Google Maps JS API 로드 (settings에서 전달된 키 사용) -->
<script async
  src="https://maps.googleapis.com/maps/api/js?key={{ GOOGLE_PLACES_API_KEY }}&callback=initMap">
</script>
{% endblock %}
